# 淡路人生ゲーム 設計定義書

バージョン: v1.0  
作成日: 2025-10-08  
対象: スマホ専用 Web アプリ (React + TypeScript + Vite + Tailwind)

---

## 1. 目的・背景
- 既存のストーリーロジック（全30マス進行、A/B分岐、RP計算）は完成済み。
- スマホ最適 UI、サイコロ進行、停止マスのモーダル表示を備えた「盤面を見ながら遊べる」体験を仕様として明文化し、実装に落とし込む。
- 既存の Canvas モード実装（「淡路島とつながる30の選択（スマホ用・canvasモード）」）をベースに再設計。データモデルと RP ロジックは変更しない前提。

## 2. スコープ
- 画面構成・ナビゲーション・コンポーネント階層
- データモデル (Board/Cell/GameState 等) と型定義
- 進行ロジック（サイコロ、分岐、移動、RP計算、リザルト）
- UI 仕様（レイアウト、操作、モーダル、アニメーション）
- 技術スタック方針、ディレクトリ構成案、最小テスト方針
- 非機能要件（パフォーマンス、アクセシビリティ、PWA 検討）

## 3. 想定利用環境
- 端末: スマートフォン（縦持ち）。基準表示領域: 幅 360px / 高さ 730px（Safe Area を考慮）。
- ブラウザ: 最新の Chromium / WebKit / Gecko。PWA 対応は将来対応（任意）。
- 入力: タッチ操作前提（ホバーなし、精密カーソル前提にしない）。

## 4. 画面構成・ナビゲーション
- 単一ページ構成（SPA）。大枠は「ヘッダー」「盤面ビュー」「操作パネル」「モーダル／リザルト」から成る。
- 盤面俯瞰表示: 全30マスを一目で把握できる横スクロールボード（初期表示で大半が見える縮尺）。
- 現在位置の強調表示（拡大／ハイライト／アニメーション）。過去マスはスクロールで振り返り可能。
- 操作パネル: 「サイコロを振る」ボタン、分岐時の A/B 選択 UI、リスタート、シェア。
- 停止時モーダル: マスの詳細、RP 変動、次の行動案内。下スワイプまたはボタンで閉じる（背景タップでは閉じない）。
- ゴール到達時: 結果表示（既存 RP 評価を流用）、再スタート、シェア。

## 5. コンポーネント構成（概略）
- AppLayout: 画面全体のレイアウト（ヘッダー、メイン、フッター領域）。
- BoardView: 盤面全体の表示と横スクロール制御。
- CellCard: 各マスのミニカード（アイコン、短文、RP 変動の記号）。
- CurrentMarker: 現在位置のハイライト／ピン表示。
- DiceButton: サイコロを振るボタン（アニメーション付き）。
- BranchPicker: 分岐マスの A/B 選択 UI（移住／東京 等）。
- StopModal: 停止マス詳細のモーダル（Headless UI ベース）。
- ResultView: 結果表示と再スタート／シェア。
- Toast/Hint: 短いフィードバック（任意）。

## 6. データモデル / 型定義（抜粋）
（注: 実コードでは TypeScript 型として定義）

- Cell
  - id: string
  - index: number (0..N-1)
  - route: 'common' | 'tokyo' | 'ijuu'（分岐以後のルート適用）
  - title: string（表示名）
  - shortText: string（盤面用の短文）
  - icon?: string（絵文字またはアセットパス）
  - effect: { rpDelta?: number; event?: 'branch' | 'end' | 'none' }
  - meta?: { isBranch?: boolean; isGoal?: boolean }

- Board
  - cells: Cell[]（index 昇順。30 マス）
  - branchCells: number[]（分岐マス index、例: [13]。値はデータで差し替え可能）

- Dice
  - lastRoll: 1..6 | null
  - animating: boolean

- Result
  - grade: 'S' | 'A' | 'B' | 'C' | 'D'
  - summary: string

- HistoryItem
  - index: number（停止マス）
  - rpDelta: number
  - timestamp: number

- GameState
  - phase: 'idle' | 'rolling' | 'moving' | 'branch' | 'modal' | 'result' | 'resetting'
  - currentIndex: number（現在のマス index）
  - route: 'none' | 'tokyo' | 'ijuu'
  - rp: number
  - dice: Dice
  - history: HistoryItem[]
  - board: Board
  - result: Result | null

## 7. ゲーム進行ロジック
- サイコロ
  - 「サイコロを振る」タップで phase: idle → rolling。
  - 0.5 秒前後のサイコロ演出後、1..6 の乱数を確定し moving へ遷移。
- 移動
  - 1 マスずつステップ移動（例: 80ms/step で currentIndex++、視覚的にマーカーを移動）。
  - オーバーシュート防止: ゴールを超える出目はゴールで停止（index = 最終マス）。
  - 分岐マス: 進行中に「次の到達点が分岐マス」の場合、分岐マス直前で停止し phase: branch に遷移。
- 分岐選択（phase: branch）
  - A/B（例: 移住／東京）を選択して route を確定。以後、cells 表示・効果は該当 route を反映。
  - 選択後は残余ステップがあれば移動再開、なければ停止処理へ。
- 停止処理（phase: modal）
  - 停止マスの effect を適用（RP 加減算等）。
  - モーダルを表示し詳細テキストと RP 変動を提示。閉じると idle に戻る。
- リザルト
  - 最終マス到達で result を算出（既存 RP → 評価ロジックを流用）。
  - ResultView を表示し、再スタート・シェア操作を提供。
- 再スタート
  - 状態を初期化（currentIndex=0, rp=0, route='none', history=[], dice 初期化）。

## 8. UI/UX 仕様
- レイアウト
  - 画面基準 360×730 を前提に CSS 変数でスケール可変（横幅に追従）。
  - BoardView は 1 行横スクロール。CellCard はタッチ目標 44px 以上、情報はアイコン＋短文＋RP 記号。
  - 現在位置は拡大・発光・アウトライン等で強調。
- 操作
  - サイコロはワンタップ。連打防止（rolling/moving 中は無効）。
  - モーダルは下スワイプ or 明示ボタンで閉じる。背景タップ無効。
  - 分岐ピッカーは 2 ボタン。選択で確定アニメーション。
- フィードバック
  - サイコロ結果の出目バウンス（~0.5s）。
  - 移動中は経路に軌跡グロー。停止時に CellCard を一時拡大。
  - RP 変動は +n / -n をバッジで一時表示。

## 9. アニメーション（推奨実装）
- DiceButton: CSS keyframes（scale/rotate）と乱数確定時の snap。
- CurrentMarker: transform による平滑移動（will-change: transform）。
- StopModal: bottom sheet（translateY）。Headless UI + Tailwind で実装。
- ResultView: フェードイン＋カウンタ（RP → 評価）演出（任意）。

## 10. 技術スタック方針
- React + TypeScript + Vite
- Tailwind CSS（既存 Canvas 実装との整合を取りつつ UI を再構成）
- 状態管理: React state（外部状態管理は不要想定）。一部ロジックはカスタムフックに分離。
- 外部ライブラリ: 必要最小限。モーダルは Headless UI の Dialog を使用可。
- シェア: Web Share API（非対応環境はクリップボードコピーにフォールバック）。

## 11. ディレクトリ構成案（例）
- src/
  - app/
    - App.tsx, routes.ts
  - features/game/
    - components/ (BoardView, CellCard, DiceButton, BranchPicker, StopModal, ResultView)
    - hooks/ (useGameState, useDice, useMovement)
    - logic/ (rules.ts, evaluator.ts)
    - data/ (board.common.ts, board.tokyo.ts, board.ijuu.ts)
    - types/ (game.ts)
  - shared/ (ui, icons, utils)

## 12. 主要フロー仕様（状態遷移）
- idle → rolling（出目演出）→ moving（逐次移動）→
  - 分岐マス直前で停止 → branch →（選択）→ moving 続行 or modal
  - それ以外は停止 → modal
- modal → idle（次の手番）
- goal 到達 → result → restart or 終了

## 13. 擬似コード（抜粋）
- rollDice
  - if phase !== 'idle' return
  - set phase='rolling'; animate ~500ms
  - const n = randInt(1,6); set lastRoll=n; set phase='moving'
- moveStep
  - while steps>0: next = currentIndex+1
    - if next is goal: currentIndex=goal; break
    - if next is branchCell: phase='branch'; break（残余 steps を保持）
    - currentIndex=next; steps--（各ステップでマーカー移動）
  - if phase!=='branch': openStopModal()
- applyCellEffect
  - rp += (cell.effect.rpDelta ?? 0); push history
- evaluateResult
  - 既存ロジックを流用して grade を算出

## 14. 非機能要件
- パフォーマンス: 60fps の移動アニメーション。レイヤー昇格（transform/opacity 中心）。
- アクセシビリティ: モーダルの focus trap、ARIA 属性、十分なコントラスト、動きの軽減設定尊重。
- レスポンシブ: 幅 320〜430 で実用化。縦固定。セーフエリア考慮。
- 国際化: 日本語前提（文言抽象化は任意）。

## 15. テスト方針（最小）
- 単体: 出目生成範囲、オーバーシュート防止、分岐停止、RP 加減算、結果評価。
- 結合: roll → move → modal の流れ、分岐選択後の残余移動、ゴール到達。
- UI: モーダルの開閉、ボタンの無効化制御、スクロールとハイライト表示。

## 16. 実装フェーズ（MVP → 拡張）
1) スケルトン & 型定義（types / rules / evaluator 下地）
2) BoardView + CellCard（静的表示）
3) GameState / Dice / 移動ロジック（出目→逐次移動）
4) StopModal（効果適用 + RP 反映）
5) 分岐 A/B（route 切替／残余移動）
6) 結果表示（評価ロジック連携）
7) UI 仕上げ（アニメーション、ハイライト、操作性）
8) シェア / PWA（任意）

## 17. 未確定事項 / 要確認
- 分岐マスの正確な index（暫定: 13。データドリブンで差し替え可能）
- 各マスの短文・アイコン・RP 変動の最終文言
- 盤面レイアウト（横一列 / 折返し / 曲線風）
- 評価ロジックの閾値（既存を流用するが、ランク境界の可視化）
- シェア文面・画像（OGP 等）

---

この設計定義書に基づき、既存データ／ロジックを活かしたスマホ最適 UI 実装を進めます。追加の制約や希望があれば反映します。

